import { Logger } from "@/utils/logger";

export type RiskLevel = 'low' | 'medium' | 'high';

export interface RiskAssessment {
    level: RiskLevel;
    score: number; // 0-100 arasƒ± risk skoru
    triggers: string[]; // Riski tetikleyen kelimeler/c√ºmleler
    warningMessage: string;
    requiresHumanReview: boolean;
}

export interface RiskKeywords {
    high: string[];
    medium: string[];
    contextual: string[]; // Baƒülam gerektiren kelimeler
}

export class RiskDetectionService {

    private static readonly RISK_KEYWORDS: RiskKeywords = {
        high: [
            // Ceza hukuku
            'mahkeme', 'icra', 'ceza', 'tutuklama', 'g√∂zaltƒ±', 'su√ß', 'hapis',
            'kesin h√ºk√ºm', 'beraat', 'mahkumiyet', 'dava', 'savcƒ±lƒ±k', 'polis',
            'karakol', 'ifade', 'sorgu', 'soru≈üturma', 'kovu≈üturma',

            // Kritik hukuki s√ºre√ßler
            'haciz', 'icra takibi', 'ihtiyati tedbir', 'tedbir kararƒ±',
            'vasi', 'kayyƒ±m', 'konkordato', 'iflas', 'aciz hali',
            'tereke', 'miras', 'vasiyet', 'velayet', 'nafaka',
            'bo≈üanma', 'mal payla≈üƒ±mƒ±', 'tazminat davasƒ±',

            // Acil durumlar
            'acil', 'ivedi', 's√ºre dolumu', 'zamana≈üƒ±mƒ±', 'hak d√º≈ü√ºr√ºc√º s√ºre',
            'temyiz', 'istinaf', 'yargƒ±tay', 'danƒ±≈ütay', 'anayasa mahkemesi'
        ],

        medium: [
            // ƒ∞≈ü hukuku
            'i≈ü s√∂zle≈ümesi', 'fesih', 'kƒ±dem tazminatƒ±', 'ihbar tazminatƒ±',
            'mobbing', 'i≈üten √ßƒ±karma', 'sendika', 'grev', 'lokavt',

            // Kira/emlak
            'kira artƒ±≈üƒ±', 'tahliye', 'kiracƒ±', 'ev sahibi', 'depozito',
            'kira s√∂zle≈ümesi', 'emlak', 'tapu', 'irtifak hakkƒ±',

            // Ticaret hukuku
            '≈üirket', 'ortaklƒ±k', 'ticaret sicili', 'vergi', 'sgk',
            's√∂zle≈üme ihlali', 'ifa', 'temerr√ºt', 'garanti', 'ayƒ±p',

            // T√ºketici haklarƒ±
            'cayma hakkƒ±', 'iade', 'deƒüi≈üim', 'garanti', 'servis',
            't√ºketici haklarƒ±', 'rekabet kurumu'
        ],

        contextual: [
            // Baƒülam gerektiren kelimeler
            'hak', 'y√ºk√ºml√ºl√ºk', 'sorumluluk', 's√∂zle≈üme', 'anla≈üma',
            'imza', 'onay', 'kabul', 'ret', 'iptal', 'fesih',
            'para', '√∂deme', 'bor√ß', 'alacak', 'kredi', 'faiz'
        ]
    };

    private static readonly HIGH_RISK_PATTERNS = [
        /mahkeme.*dava/gi,
        /icra.*takip/gi,
        /ceza.*hapis/gi,
        /tutuklama.*g√∂zaltƒ±/gi,
        /haciz.*el koyma/gi,
        /s√ºre.*dolum/gi,
        /acil.*ivedi/gi,
        /tazminat.*dava/gi
    ];

    private static readonly MEDIUM_RISK_PATTERNS = [
        /i≈üten.*√ßƒ±karma/gi,
        /kira.*artƒ±≈ü/gi,
        /s√∂zle≈üme.*fesih/gi,
        /vergi.*bor√ß/gi
    ];

    /**
     * Ana risk deƒüerlendirme fonksiyonu
     */
    static assessRisk(text: string, documentType?: string): RiskAssessment {
        try {
            const normalizedText = text.toLowerCase().trim();
            let riskScore = 0;
            const triggers: string[] = [];

            // Y√ºksek risk kelimelerini kontrol et
            const highRiskMatches = this.findKeywordMatches(normalizedText, this.RISK_KEYWORDS.high);
            riskScore += highRiskMatches.length * 20;
            triggers.push(...highRiskMatches);

            // Orta risk kelimelerini kontrol et  
            const mediumRiskMatches = this.findKeywordMatches(normalizedText, this.RISK_KEYWORDS.medium);
            riskScore += mediumRiskMatches.length * 10;
            triggers.push(...mediumRiskMatches);

            // Pattern matching
            const highPatternMatches = this.findPatternMatches(normalizedText, this.HIGH_RISK_PATTERNS);
            riskScore += highPatternMatches.length * 25;
            triggers.push(...highPatternMatches);

            const mediumPatternMatches = this.findPatternMatches(normalizedText, this.MEDIUM_RISK_PATTERNS);
            riskScore += mediumPatternMatches.length * 15;
            triggers.push(...mediumPatternMatches);

            // Baƒülamsal analiz
            const contextualScore = this.assessContextualRisk(normalizedText);
            riskScore += contextualScore;

            // Dok√ºman tipi risk bonusu
            if (documentType) {
                riskScore += this.getDocumentTypeRiskBonus(documentType);
            }

            // Risk seviyesi belirleme
            const level = this.determineRiskLevel(riskScore);
            const warningMessage = this.generateWarningMessage(level, triggers);
            const requiresHumanReview = level === 'high' || riskScore > 70;

            const assessment: RiskAssessment = {
                level,
                score: Math.min(riskScore, 100),
                triggers: [...new Set(triggers)], // Benzersiz hale getir
                warningMessage,
                requiresHumanReview
            };

            // Log assessment
            Logger.log('RiskDetection', 'Risk assessment completed', {
                level,
                score: assessment.score,
                triggersCount: triggers.length,
                requiresReview: requiresHumanReview
            });

            return assessment;

        } catch (error) {
            Logger.error('RiskDetection', 'Risk assessment failed', error);

            // G√ºvenli fallback - her zaman orta risk d√∂nd√ºr
            return {
                level: 'medium',
                score: 50,
                triggers: ['Risk deƒüerlendirme hatasƒ±'],
                warningMessage: 'Risk deƒüerlendirmesi yapƒ±lamadƒ±. G√ºvenlik i√ßin uzman desteƒüi almanƒ±zƒ± √∂neriyoruz.',
                requiresHumanReview: true
            };
        }
    }

    /**
     * Kelime e≈üle≈ümelerini bul
     */
    private static findKeywordMatches(text: string, keywords: string[]): string[] {
        const matches: string[] = [];
        for (const keyword of keywords) {
            if (text.includes(keyword.toLowerCase())) {
                matches.push(keyword);
            }
        }
        return matches;
    }

    /**
     * Pattern e≈üle≈ümelerini bul
     */
    private static findPatternMatches(text: string, patterns: RegExp[]): string[] {
        const matches: string[] = [];
        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
                matches.push(match[0]);
            }
        }
        return matches;
    }

    /**
     * Baƒülamsal risk deƒüerlendirmesi
     */
    private static assessContextualRisk(text: string): number {
        let contextualScore = 0;

        // C√ºmle uzunluƒüu ve karma≈üƒ±klƒ±k
        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 10);
        if (sentences.length > 20) contextualScore += 5;

        // Hukuki terim yoƒüunluƒüu
        const legalTerms = this.RISK_KEYWORDS.contextual.filter(term =>
            text.includes(term.toLowerCase())
        ).length;
        contextualScore += Math.min(legalTerms * 2, 20);

        // Para miktarƒ± referanslarƒ±
        if (/\d+.*tl|lira|euro|dolar/gi.test(text)) {
            contextualScore += 10;
        }

        // Tarih ve s√ºre referanslarƒ±
        if (/\d+.*g√ºn|ay|yƒ±l|tarih/gi.test(text)) {
            contextualScore += 5;
        }

        return contextualScore;
    }

    /**
     * Dok√ºman tipi risk bonusu
     */
    private static getDocumentTypeRiskBonus(documentType: string): number {
        const highRiskDocuments = ['mahkeme', 'icra', 'ceza', 'dava', 'tazminat'];
        const mediumRiskDocuments = ['kira', 'i≈ü', 's√∂zle≈üme', 'fesih'];

        const docType = documentType.toLowerCase();

        if (highRiskDocuments.some(type => docType.includes(type))) {
            return 15;
        }

        if (mediumRiskDocuments.some(type => docType.includes(type))) {
            return 8;
        }

        return 0;
    }

    /**
     * Risk seviyesi belirleme
     */
    private static determineRiskLevel(score: number): RiskLevel {
        if (score >= 60) return 'high';
        if (score >= 30) return 'medium';
        return 'low';
    }

    /**
     * Risk seviyesine g√∂re uyarƒ± mesajƒ± olu≈ütur
     */
    private static generateWarningMessage(level: RiskLevel, triggers: string[]): string {
        const baseMessages = {
            high: 'Bu kritik bir hukuki konudur. Herhangi bir adƒ±m atmadan √∂nce mutlaka bir avukata danƒ±≈ümanƒ±zƒ± ≈üiddetle tavsiye ederiz.',
            medium: 'Bu konuda profesyonel destek almanƒ±zƒ± √∂neriyoruz. Hukuki s√ºre√ßler karma≈üƒ±k olabilir.',
            low: 'Bu bilgiler genel niteliktedir. Ki≈üisel durumunuz i√ßin uzman g√∂r√º≈ü√º almanƒ±z faydalƒ± olacaktƒ±r.'
        };

        let message = baseMessages[level];

        // √ñzel trigger'lara g√∂re ek uyarƒ±lar
        if (triggers.some(t => ['mahkeme', 'dava', 'icra'].includes(t.toLowerCase()))) {
            message += '\n\nüö® Bu konu mahkeme s√ºreci i√ßeriyor. Hukuki temsil almanƒ±z kritik √∂nem ta≈üƒ±r.';
        }

        if (triggers.some(t => ['s√ºre', 'zamana≈üƒ±mƒ±', 'hak d√º≈ü√ºr√ºc√º'].some(s => t.toLowerCase().includes(s)))) {
            message += '\n\n‚è∞ S√ºre sƒ±nƒ±rlamasƒ± olabilir. Gecikme hak kaybƒ±na yol a√ßabilir.';
        }

        if (triggers.some(t => ['ceza', 'su√ß', 'hapis'].includes(t.toLowerCase()))) {
            message += '\n\n‚öñÔ∏è Bu ceza hukuku konusudur. Derhal bir avukatla ileti≈üime ge√ßin.';
        }

        return message;
    }

    /**
     * Risk seviyesine g√∂re UI tema renklerini al
     */
    static getRiskThemeColors(level: RiskLevel) {
        const themes = {
            high: {
                bg: 'bg-red-50',
                border: 'border-red-500',
                text: 'text-red-700',
                icon: 'text-red-500'
            },
            medium: {
                bg: 'bg-yellow-50',
                border: 'border-yellow-500',
                text: 'text-yellow-700',
                icon: 'text-yellow-500'
            },
            low: {
                bg: 'bg-blue-50',
                border: 'border-blue-500',
                text: 'text-blue-700',
                icon: 'text-blue-500'
            }
        };

        return themes[level];
    }

    /**
     * Hƒ±zlƒ± risk kontrol√º (sadece kelime bazlƒ±)
     */
    static quickRiskCheck(text: string): RiskLevel {
        const normalizedText = text.toLowerCase();

        // Y√ºksek risk kelimeler varsa
        const hasHighRisk = this.RISK_KEYWORDS.high.some(keyword =>
            normalizedText.includes(keyword.toLowerCase())
        );

        if (hasHighRisk) return 'high';

        // Orta risk kelimeler varsa
        const hasMediumRisk = this.RISK_KEYWORDS.medium.some(keyword =>
            normalizedText.includes(keyword.toLowerCase())
        );

        if (hasMediumRisk) return 'medium';

        return 'low';
    }
}